<!DOCTYPE html>
<html>
<head>
  	<meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
    <link type="text/css" rel="stylesheet" href="d3_collapsibleTree.css"/>
	<link type="text/css" rel="stylesheet" href="../../css/main.css"/>
	<script type="text/javascript" src="../../js/d3.min.js"></script>
    <script type="text/javascript" src="../../js/d3.layout.js"></script>
    <!-- own plugins to handle AVM based on D3.js -->
    <script type="text/javascript" src="../../js/ogvic.js"></script>
    <style type="text/css">


    </style>
</head>
<body><div id="body"></div>
	
<script type="text/javascript">

/******************************/
/* CREDITS        			  */
/******************************/
            	
/* after an example from http://bl.ocks.org/mbostock/4339083 */

/******************/
/* SETTINGS       */
/******************/

var m = [20, 120, 20, 120],
    w = 1280 - m[1] - m[3],
    h = 800 - m[0] - m[2],
    i = 0,
    root;

/******************/
/* GLOBAL VARS    */
/******************/

var tree = d3.layout.tree()
    .size([h, w]);

var diagonal = d3.svg.diagonal()
    .projection(function(d) { return [d.y, d.x]; });
    
/******************************/
/* BASIC PAGE BUILDING        */
/******************************/

var vis = d3.select("#body").append("svg:svg")
    .attr("width", w + m[1] + m[3])
    .attr("height", h + m[0] + m[2])
  .append("svg:g")
    .attr("transform", "translate(" + m[3] + "," + m[0] + ")");
    
    
/**************************/
/* START DATA DRIVE       */
/**************************/

d3.json("../../gen/json/tree-data.json", function(json) {

  root = json;
  root.x0 = h / 2;
  root.y0 = 0;
  
  /******************************/
  /* LOCAL(?) FUNCTIONS         */
  /******************************/

  function toggleAll(d) {
    if (d.children) {
      d.children.forEach(toggleAll);
      toggle(d);
    }
  }

  // Initialize the display to show a few nodes.
  //root.children.forEach(toggleAll);
  //toggle(root.children[1]);
  //toggle(root.children[1].children[2]);
  //toggle(root.children[9]);
  //toggle(root.children[9].children[0]);

  update(root);
});

function update(source) {
	
	 var symbolFunction = d3.svg.symbol()
 						.size(300)
 						.type(function (d) {return d.shape_d3_name})
						;
						
						
  var duration = d3.event && d3.event.altKey ? 5000 : 500;

  // Compute the new tree layout.
  var nodes = tree.nodes(root).reverse();

  // Normalize for fixed-depth.
  nodes.forEach(function(d) { d.y = d.depth * 180; });

  // Update the nodes…
  var node = vis.selectAll("g.node")
      .data(nodes, function(d) { return d.id || (d.id = ++i); });
	  

	function activate(d, active) {
		d.active = active;
		d.parent && activate(d.parent, active);
	}
	
	function activateChildren(d, active) {
		d.active = active;
		d.children && d.children.forEach(function(child) {
			activate(child, active);
			});
	}


  // Enter any new nodes at the parent's previous position.
  var nodeEnter = node.enter().append("svg:g")
      .attr("class", "node")
      .attr("transform", function(d) { return "translate(" + source.y0 + "," + source.x0 + ")"; })
      .on("click", function(d) { toggle(d); update(d); })
	  
	  .on("mouseover", function(d) {
	  	
			var nodesToFilter = vis.selectAll(".node");
			var linksToFilter = vis.selectAll(".link");
	  		
			// highlight this node
			d3.select(this).highlight();

			// highlight identical nodes	
			nodesToFilter.avmHighlightIdentical(d.uri);

			// highlight parent and children nodes and the path
			
			activate(d, true);
			activateChildren(d, true);

			nodesToFilter.filter(function(node) {
			    return node.active;
            })
			.highlight();
			linksToFilter.filter(function(d) { 
				return d.target.active;
			 })
			 .highlight()
			 ;
				
	  })
	  .on("mouseout", function(d) {
			
			d3.selectAll(".node").classed("highlighted identical", false);
			vis.selectAll(".link").classed("highlighted", false);
			
			activate(d, false);
			activateChildren(d, false);
			
	  })
	  ;

	

		// shapes as reused svg-groups
		var symbol = nodeEnter.avmShapedWithUseSVG();

		// The label and a copy of the label as shadow for better readability
		nodeEnter.avmLabeledCT().attr("class", "nodeLabelShadow");
		nodeEnter.avmLabeledCT();

		// tooltip
		nodeEnter.avmTitled();

		// Transition nodes to their new position.
		var nodeUpdate = node.transition().duration(duration).attr("transform",
				function(d) {
					return "translate(" + d.y + "," + d.x + ")";
				});

		nodeUpdate.select("path").style("visibility", "visible");

		nodeUpdate.selectAll("text").style("visibility", "visible");

		// Transition exiting nodes to the parent's new position.
		var nodeExit = node.exit().transition().duration(duration).attr(
				"transform", function(d) {
					return "translate(" + source.y + "," + source.x + ")";
				}).remove();

		nodeExit.select("path").style("visibility", "hidden");

		nodeExit.selectAll("text").style("visibility", "hidden");

		// Update the links…
		var link = vis.selectAll("path.link").data(tree.links(nodes),
				function(d) {
					return d.target.id;
				});

		// Enter any new links at the parent's previous position.
		var linkEnter = link.enter().insert("svg:path", "g").attr("class",
				"link").style("stroke", function(d) {
			return d.target.connector_color_rgb_hex_combined
		}) // works -> get the link color from the endNode (target)
		.attr("d", function(d) {
			var o = {
				x : source.x0,
				y : source.y0
			};
			return diagonal({
				source : o,
				target : o
			});
		});

		linkEnter.transition().duration(duration).attr("d", diagonal);

		linkEnter.append("svg:title").text(function(d) {
			return d.target.connector_label;
		});

		// Transition links to their new position.
		link.transition().duration(duration).attr("d", diagonal);

		// Transition exiting nodes to the parent's new position.
		link.exit().transition().duration(duration).attr("d", function(d) {
			var o = {
				x : source.x,
				y : source.y
			};
			return diagonal({
				source : o,
				target : o
			});
		}).remove();

		// Stash the old positions for transition.
		nodes.forEach(function(d) {
			d.x0 = d.x;
			d.y0 = d.y;
		});
		
	}

	/******************/
	/* SET UP         */
	/******************/

	// Toggle children.
	function toggle(d) {
		if (d.children) {
			d._children = d.children;
			d.children = null;
		} else {
			d.children = d._children;
			d._children = null;
		}
	}
</script>
	
<svg id="svg-effects">
	
    <filter id="blur-effect-1">
        <feGaussianBlur stdDeviation="0.9" />
    </filter>

    <filter id="blur-effect-2">
        <feGaussianBlur stdDeviation="2" />
    </filter>
		
</svg> 

</body>
</html>
