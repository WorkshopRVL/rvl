<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
	<link type="text/css" rel="stylesheet" href="../../css/main.css"/>
	<link type="text/css" rel="stylesheet" href="../../css/labeling.css"/>
	<link type="text/css" rel="stylesheet" href="../../css/labeling-moz.css"/>
	<script type="text/javascript" src="../../js/d3.min.js"></script>
	<style type="text/css">
		
	
	</style>
</head>
<body>
	
		
<div id="labelContainerSpace">
</div>
	

<script type="text/javascript">
/* after an example from http://jsfiddle.net/Y9Qq3/2/ http://jsfiddle.net/Y9Qq3/2/ */

var drawLinks = true; // choose whether only nodes should be drawn and layouted
	

var width = 800,
    height = 800,
	markerWidth = 3,
    markerHeight = 3,
    cRadius = 12,
    refX = cRadius + (markerWidth * 2),
    refY = -Math.sqrt(cRadius)
    drSub = cRadius + refY
;

					 

	

//var color = d3.scale.category20();

var force = self.force = d3.layout.force()
    .charge(-900)
    .linkDistance(100)
    .size([width, height])
	;

var svg = d3.select("body").append("svg")
    .attr("width", width)
    .attr("height", height);
	
var labelContainerSpace = d3.select("#labelContainerSpace")
	//.style("position","absolute")
	//.attr("id", "labelContainerSpace") // somehow does not work programmatically
    .attr("width", width)
    .attr("height", height);
	
	

d3.json("../../gen/json/graph-data.json", function(error, graph) {
//d3.json("graph-data-1.json", function(error, graph) {
	
	 var symbolFunction = d3.svg.symbol()
 						.size(1500)
 						.type(function (d) {return d.shape_d3_name})
						;
						
		 var labelSymbolFunction = d3.svg.symbol()
 						.size(250)
 						.type(function (d) {return d.label_shape_d3_name})
						//.type("cross")
						;
	
	  var forceVar = force
	      .nodes(graph.nodes);
	  if (drawLinks) {
	  	forceVar.links(graph.links)
	  }
	  	forceVar.start();
		  
		  
		 var path = svg.selectAll(".link")
        .data(graph.links)
        .enter().append("svg:path")
        .attr("class", function (d) { return "link link" + d.type; })  
		//.style("stroke", function(d) { return d.color_rgb_hex; })
		.style("stroke", function(d) { return d.color_rgb_hex_combined; })
		.attr("marker-end", function (d) {
        	//return "url(#" + d.type + ")";
			return "url(#" + "link" + ")";
    	})
		;
		
		  
		  var node_drag = d3.behavior.drag()
        .on("dragstart", dragstart)
        .on("drag", dragmove)
        .on("dragend", dragend);
		
		function dragstart(d, i) {
        forceVar.stop() // stops the force auto positioning before you start dragging
    }

    function dragmove(d, i) {
        d.px += d3.event.dx;
        d.py += d3.event.dy;
        d.x += d3.event.dx;
        d.y += d3.event.dy; 
        tick(); // this is the key to make it work together with updating both px,py,x,y on d !
    }

    function dragend(d, i) {
        d.fixed = true; // of course set the node to fixed so the force doesn't include the node in its auto positioning stuff
        tick();
        forceVar.resume();
    }

	

	    /*Create and place the "blocks" containing the circle and the text */  
    	var nodeEnter = svg.selectAll(".node")
	      .data(graph.nodes).enter()
	    .append("g")
		.attr("class", "node")
	    //.attr("transform", function(d){return "translate("+d.x+",80)"})
		//.attr("transform", function(d){return "translate(+20,80)"})
		.call(node_drag)
		
		
	
	var symbol = nodeEnter.append("path")
    //.attr("transform", function(d) { return "translate(" + d.x + "," + d.y + ")"; })
    //.attr("d", d3.svg.symbol());
	  .attr("class", function(d) { return "node" })
	 .attr("d", symbolFunction)
	 .style("fill", function(d) { return d.color_rgb_hex_combined; })
	 ;	
	 
	 var nodeShapeSize = Math.sqrt(1500); /* TODO area set in symbol functions */ 
	 var labelShapeSize = nodeShapeSize/2;
	 
	 
	
	var labelContainer = d3.select("#labelContainerSpace")
		.selectAll(".labelContainer.bottomRight")
		.data(graph.nodes).enter()
		.append("div")
		.attr("class","labelContainer bottomRight")
		.style("height",nodeShapeSize +"px")
		.style("width",nodeShapeSize +"px");
		
		labelContainer.append("svg")
			.attr("class", "svgLabelIcon")
			.attr("width",labelShapeSize +"px")
			.attr("height",labelShapeSize +"px")
			.style("margin",-labelShapeSize/2.75 + "px")
			/*.append("svg:circle")
				.attr("r", labelShapeSize/2)
				.attr("cx",labelShapeSize/2)
				.attr("cy",labelShapeSize/2)
				.style("fill","red");*/
			.append("path")
	  			.attr("class", "label")
	 			.attr("d", labelSymbolFunction)
	 			.style("fill", "red")
				.attr("transform", function(d){ return "translate(" + labelShapeSize/2 + "," + labelShapeSize/2 + ")"})
			 ;
			
	// SVG label in html div (will not work for other position, maybe create a much bigger SVG inside the div, or modify clipping) 
	
	
	var labelContainer3 = d3.select("#labelContainerSpace")
		.selectAll(".labelContainer.bottomLeft")
		.data(graph.nodes).enter()
		.append("div")
		.attr("class","labelContainer bottomLeft")
		.style("height",nodeShapeSize +"px")
		.style("width",nodeShapeSize +"px")
		;
		
		labelContainer3.append("svg")
			.attr("class", "svgLabelIcon")
			.attr("width",100 +"px")
			.attr("height",25 +"px")
			.style("margin-left",-100 + "px")
			.style("margin-bottom",-0.2*nodeShapeSize + "px")
			.append("text")
				.attr("class", "label")
			    .attr("dx", function(d){return 100})
				.attr("dy", function(d){return 20})
			    .text(function(d){return d.label })
				.style("text-anchor","end")
				;
				
				
			 
	// HTML label
			 
	var labelContainer2 = d3.select("#labelContainerSpace")
		.selectAll(".labelContainer.topRight")
		.data(graph.nodes).enter()
		.append("div")
		.attr("class","labelContainer topRight")
		.style("height",nodeShapeSize +"px")
		.style("width",nodeShapeSize +"px");
		
		labelContainer2
			.append("div")
	  			.attr("class", "htmlTextLabel")
				/*.style("width", nodeShapeSize + "px")*/ // does only work well for xCenter position
				.html(function(d){ return d.label})
			 ;
			 
			 
			 
		 
		  	
	/*	
	
	// SVG label at svg node
	
	nodeEnter.append("text")
		.attr("class", "nodeLabel")
	    .attr("dx", function(d){return 10})
		.attr("dy", function(d){return 0})
	    .text(function(d){return d.label })
	    //.text(function(d){return d.label + " lightness: " +  d.color_hsl_lightness + " rgb combined: " + d.color_rgb_hex_combined + " rgb pure: " + d.color_rgb_hex  })
		//.text(function(d){return d.label + " (shape: " + d.shape_d3_name + ")"})
		;
		
	*/
	
		
	
	  
	  
	  // Use elliptical arc path segments to doubly-encode directionality.
    //function tick() {
	tick = function() {
        path.attr("d", function (d) {
            var dx = d.target.x - d.source.x,
                dy = (d.target.y - d.source.y),
                dr = Math.sqrt(dx * dx + dy * dy);
            return "M" + d.source.x + "," + d.source.y + "A" + (dr - drSub) + "," + (dr - drSub) + " 0 0,1 " + d.target.x + "," + d.target.y;
        });

        nodeEnter.attr("transform", function (d) {
            return "translate(" + d.x + "," + d.y + ")";
        });
		
		labelContainer
			.style("top", function(d){
				return d.y - nodeShapeSize/2 + "px";
			})
			.style("left", function(d){
				return d.x -nodeShapeSize/2 + "px";
			});
			
		labelContainer2
			.style("top", function(d){
				return d.y - nodeShapeSize/2 + "px";
			})
			.style("left", function(d){
				return d.x -nodeShapeSize/2 + "px";
			});
			
		labelContainer3
			.style("top", function(d){
				return d.y - nodeShapeSize/2 + "px";
			})
			.style("left", function(d){
				return d.x -nodeShapeSize/2 + "px";
			});

    };
	
	force.on("tick", tick);
	  

});

</script>


<svg id="svg-effects">
    <filter id="blur-effect-1">
        <feGaussianBlur stdDeviation="0.9" />
    </filter>

    <filter id="blur-effect-2">
        <feGaussianBlur stdDeviation="2" />
    </filter>
</svg> 

</body>
</html>
